<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Daye's Sweets Blog</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Press Start 2P', monospace;
      background: #FFF8E7;
      color: #4B3B2D;
    }
    header {
      background: #FF91A4;
      padding: 120px 20px;
      text-align: center;
      font-size: 3em;
      color: white;
    }
    .container {
      display: flex;
      min-height: 90vh;
    }
    nav {
      flex: 2;
      min-width: 200px;
      background: #FFD1DC;
      padding: 20px;
    }
    nav ul {
      list-style: none;
      padding: 0;
    }
    nav li {
      margin-bottom: 12px;
      cursor: pointer;
      font-size: 0.95em;
      position: relative;
    }
    nav li ul {
      display: none;
      list-style: none;
      padding-left: 15px;
      position: absolute;
      top: 0;
      left: 100%;
      background: #FFD1DC;
      padding: 10px;
      border-radius: 5px;
    }
    nav li:hover > ul {
      display: block;
    }
    main {
      flex: 8;
      background: #FFFBF0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .post {
      width: 23%;
      margin: 10px;
      border: 1px solid #FFD1DC;
      border-radius: 10px;
      background: #FFF0F5;
      cursor: pointer;
      padding: 10px;
    }
    .post img {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 5px;
    }
    .edit-delete {
      position: absolute;
      right: 10px;
      bottom: 10px;
    }
    textarea, input, select {
      width: 100%;
      padding: 5px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: 1px solid #FFD1DC;
      font-family: 'Press Start 2P', monospace;
    }
    button {
      cursor: pointer;
      background: #FF91A4;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 12px;
      margin: 5px 0;
    }
    button:hover {
      background: #FF6F91;
    }
    .hidden {
      display: none;
    }
    #writeBtn {
      margin-bottom: 20px;
    }
    #loginForm {
      margin-top: 50px;
      width: 100%;
      max-width: 400px;
      padding: 20px;
      border: 1px solid #FFD1DC;
      border-radius: 10px;
      background: #FFF0F5;
    }
    #postForm {
      width: 100%;
      max-width: 1200px;
      padding: 50px;
      border: 1px solid #FFD1DC;
      border-radius: 10px;
      margin-top: 50px;
      background: #FFF0F5;
    }
    #postForm textarea {
      height: 500px;
    }
    .pagination {
      margin: 20px 0;
    }
    .page-btn {
      margin: 0 5px;
      cursor: pointer;
      background: #FF91A4;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
    }
    .page-btn:hover {
      background: #FF6F91;
    }
    @media screen and (max-width: 1024px) { .post { width: 31%; } }
    @media screen and (max-width: 768px) {
      .container { flex-direction: column; }
      nav { width: 100%; }
      main { width: 100%; }
      .post { width: 48%; }
    }
    @media screen and (max-width: 480px) {
      .post { width: 100%; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <header>Daye's Sweets Blog</header>
  <div class="container">
    <nav>
      <ul>
        <li id="menuHome">Home</li>
        <li id="menuToday">Today's Sweets</li>
        <li id="menuCategories">Categories
          <ul>
            <li>Seasonal Specials</li>
            <li>Drinks</li>
            <li>Bread</li>
            <li>Cookie</li>
            <li>Cake</li>
            <li>Chocolate</li>
            <li>Ice Cream</li>
            <li>Candy</li>
            <li>Jelly</li>
            <li>Others</li>
          </ul>
        </li>
        <li id="menuGallery">Gallery</li>
        <li id="menuDaily">Daily Life</li>
        <li id="menuShops">Favorite Shops</li>
        <li id="menuRecipes">Recipes</li>
        <li id="menuGuest">Guestbook</li>
      </ul>
    </nav>
    <main>
      <div id="postsContainer"></div>

      <div id="postDetail" class="hidden">
        <img id="detailImg" src="" alt="">
        <h3 id="detailTitle"></h3>
        <p id="detailContent"></p>
        <div class="edit-delete hidden">
          <button id="editBtn">Edit</button>
          <button id="deleteBtn">Delete</button>
        </div>
        <button onclick="closeDetail()">Back</button>
      </div>

      <button id="writeBtn">Write a post</button>

      <div id="loginForm" class="hidden">
        <h3>Login</h3>
        <input type="text" id="username" placeholder="Username"><br>
        <input type="password" id="password" placeholder="Password"><br>
        <button onclick="login()">Login</button>
        <button onclick="closeLogin()">Cancel</button>
      </div>

      <div id="postForm" class="hidden">
        <h3>Write a Post</h3>
        <input type="text" id="postTitle" placeholder="Title"><br>
        <textarea id="postContent" placeholder="Content"></textarea><br>
        <input type="file" id="postImgFile" accept="image/*"><br>
        <select id="postCategory">
          <option>Seasonal Specials</option>
          <option>Drinks</option>
          <option>Bread</option>
          <option>Cookie</option>
          <option>Cake</option>
          <option>Chocolate</option>
          <option>Ice Cream</option>
          <option>Candy</option>
          <option>Jelly</option>
          <option>Others</option>
        </select><br>
        <button id="saveBtn">Save</button>
        <button onclick="cancelPost()">Cancel</button>
      </div>

      <div class="pagination hidden" id="pagination"></div>
    </main>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      doc,
      updateDoc,
      deleteDoc,
      orderBy,
      query
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
      deleteObject
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBSoB4NomotkzPQgymHGqDhuy7POreIVzg",
      authDomain: "daye-sweets-blog.firebaseapp.com",
      projectId: "daye-sweets-blog",
      storageBucket: "daye-sweets-blog.appspot.com",
      messagingSenderId: "175818595197",
      appId: "1:175818595197:web:f2290dfcf5321bf1930a14"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let loggedIn = false;
    let currentPostId = null;
    let allPosts = [];
    const postsPerPage = 16;

    const postsContainer = document.getElementById("postsContainer");
    const postDetail = document.getElementById("postDetail");
    const detailImg = document.getElementById("detailImg");
    const detailTitle = document.getElementById("detailTitle");
    const detailContent = document.getElementById("detailContent");
    const editDelete = document.querySelector(".edit-delete");
    const loginForm = document.getElementById("loginForm");
    const postForm = document.getElementById("postForm");
    const writeBtn = document.getElementById("writeBtn");
    const saveBtn = document.getElementById("saveBtn");
    const paginationDiv = document.getElementById("pagination");
    // 로그인 기능
    writeBtn.addEventListener("click", () => {
      loginForm.style.display = "block";
      loginForm.scrollIntoView({ behavior: "smooth" });
    });

    function login() {
      const u = document.getElementById("username").value;
      const p = document.getElementById("password").value;
      if (u === "day" && p === "1004") {
        loggedIn = true;
        alert("Login success!");
        loginForm.style.display = "none";
        postForm.style.display = "block";
        postForm.scrollIntoView({ behavior: "smooth" });
      } else {
        alert("Incorrect ID or password");
      }
    }

    function closeLogin() {
      loginForm.style.display = "none";
    }

    function cancelPost() {
      postForm.style.display = "none";
    }

    // 글 저장
    saveBtn.addEventListener("click", async () => {
      const title = document.getElementById("postTitle").value;
      const content = document.getElementById("postContent").value;
      const category = document.getElementById("postCategory").value;
      const fileInput = document.getElementById("postImgFile");

      if (!title || !content || fileInput.files.length === 0) {
        alert("Title, Content, and Image required");
        return;
      }

      const file = fileInput.files[0];
      const storageRef = ref(storage, 'images/' + file.name);
      await uploadBytes(storageRef, file);
      const imgURL = await getDownloadURL(storageRef);

      await addDoc(collection(db, "posts"), {
        title,
        content,
        category,
        img: imgURL,
        timestamp: Date.now()
      });

      postForm.style.display = "none";
      loadPosts();
    });

    // 글 불러오기
    async function loadPosts() {
      const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      allPosts = [];
      snapshot.forEach(doc => {
        allPosts.push({ id: doc.id, ...doc.data() });
      });
      renderPosts(1);
    }

    // 글 렌더링
    function renderPosts(page) {
      postsContainer.innerHTML = "";
      const start = (page - 1) * postsPerPage;
      const end = start + postsPerPage;
      const pagePosts = allPosts.slice(start, end);

      pagePosts.forEach(post => {
        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `<img src="${post.img}" alt=""><h3>${post.title}</h3>`;
        div.onclick = () => viewPost(post.id);
        postsContainer.appendChild(div);
      });

      renderPagination(page);
    }

    // 페이지네이션
    function renderPagination(currentPage) {
      paginationDiv.innerHTML = "";
      paginationDiv.classList.remove("hidden");
      const totalPages = Math.ceil(allPosts.length / postsPerPage);

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.className = "page-btn";
        btn.innerText = i;
        if (i === currentPage) btn.style.background = "#FF6F91";
        btn.onclick = () => renderPosts(i);
        paginationDiv.appendChild(btn);
      }
    }

    // 상세보기
    async function viewPost(id) {
      const post = allPosts.find(p => p.id === id);
      if (!post) return;

      currentPostId = id;
      detailImg.src = post.img;
      detailTitle.innerText = post.title;
      detailContent.innerText = post.content;
      postDetail.style.display = "flex";

      if (loggedIn) {
        editDelete.classList.remove("hidden");
      } else {
        editDelete.classList.add("hidden");
      }
    }

    function closeDetail() {
      postDetail.style.display = "none";
    }

    // 수정
    document.getElementById("editBtn").addEventListener("click", () => {
      const post = allPosts.find(p => p.id === currentPostId);
      if (!post) return;

      document.getElementById("postTitle").value = post.title;
      document.getElementById("postContent").value = post.content;
      document.getElementById("postCategory").value = post.category;
      postForm.style.display = "block";

      saveBtn.onclick = async () => {
        await updateDoc(doc(db, "posts", currentPostId), {
          title: document.getElementById("postTitle").value,
          content: document.getElementById("postContent").value,
          category: document.getElementById("postCategory").value,
          timestamp: Date.now()
        });
        postForm.style.display = "none";
        loadPosts();
      };
    });

    // 삭제
    document.getElementById("deleteBtn").addEventListener("click", async () => {
      const post = allPosts.find(p => p.id === currentPostId);
      if (!post) return;

      try {
        const imgRef = ref(storage, post.img);
        await deleteObject(imgRef);
      } catch (e) {
        console.warn("이미지 삭제 실패:", e);
      }

      await deleteDoc(doc(db, "posts", currentPostId));
      postDetail.style.display = "none";
      loadPosts();
    });

    // 초기 로딩
    loadPosts();
  </script>
  </script>
</body>
</html>
