<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Daye's Sweets Blog</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Press Start 2P', monospace;
      background: #FFFBF0;
      color: #4B3B2D;
    }
    header {
      background: #FF91A4;
      padding: 150px 20px;
      text-align: center;
      font-size: 3em;
      color: white;
    }
    .container {
      display: flex;
      min-height: 90vh;
      flex-direction: row;
    }
    nav {
      flex: 2;
      min-width: 200px;
      background: #FFD1DC;
      padding: 20px;
    }
    nav ul {
      list-style: none;
      padding: 0;
    }
    nav li {
      margin-bottom: 12px;
      cursor: pointer;
      font-size: 0.95em;
    }
    nav li ul {
      display: none;
      margin-left: 15px;
    }
    nav li:hover > ul {
      display: block;
    }
    main {
      flex: 8;
      background: #FFFBF0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .post {
      width: 23%;
      margin: 10px;
      border: 1px solid #FFD1DC;
      border-radius: 10px;
      background: #FFF0F5;
      cursor: pointer;
      padding: 10px;
    }
    .post img {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 5px;
    }
    .edit-delete {
      position: absolute;
      right: 10px;
      bottom: 10px;
    }
    textarea, input, select {
      width: 100%;
      padding: 5px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: 1px solid #FFD1DC;
      font-family: 'Press Start 2P', monospace;
    }
    button {
      cursor: pointer;
      background: #FF91A4;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 12px;
      margin: 5px 0;
    }
    button:hover {
      background: #FF6F91;
    }
    .hidden {
      display: none;
    }
    #writeBtn {
      margin-bottom: 20px;
    }
    #loginForm {
      margin-top: 50px;
      width: 100%;
      max-width: 400px;
      padding: 20px;
      border: 1px solid #FFD1DC;
      border-radius: 10px;
      background: #FFF0F5;
    }
    #postForm {
      width: 100%;
      max-width: 1000px;
      padding: 50px;
      border: 1px solid #FFD1DC;
      border-radius: 10px;
      margin-top: 50px;
      background: #FFF0F5;
    }
    #postForm textarea {
      height: 500px;
    }
    @media screen and (max-width: 1024px) { .post { width: 31%; } }
    @media screen and (max-width: 768px) {
      .container { flex-direction: column; }
      nav { width: 100%; }
      main { width: 100%; }
      .post { width: 48%; }
    }
    @media screen and (max-width: 480px) {
      .post { width: 100%; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <header>Daye's Sweets Blog</header>
  <div class="container">
    <nav>
      <ul>
        <li>Home</li>
        <li>Today's Sweets</li>
        <li>Categories
          <ul>
            <li>Seasonal Specials
              <ul>
                <li>Halloween</li>
                <li>Christmas</li>
              </ul>
            </li>
            <li>Drinks</li>
            <li>Bread</li>
            <li>Cookie</li>
            <li>Cake</li>
            <li>Chocolate</li>
            <li>Ice Cream</li>
            <li>Candy</li>
            <li>Jelly</li>
            <li>Others</li>
          </ul>
        </li>
        <li>Gallery</li>
        <li>Daily Life</li>
        <li>Favorite Shops</li>
        <li>Recipes</li>
        <li>Guestbook</li>
      </ul>
    </nav>
    <main>
      <div id="postsContainer"></div>

      <div id="postDetail" class="hidden">
        <img id="detailImg" src="" alt="">
        <h3 id="detailTitle"></h3>
        <p id="detailContent"></p>
        <div class="edit-delete hidden">
          <button id="editBtn">Edit</button>
          <button id="deleteBtn">Delete</button>
        </div>
        <button onclick="closeDetail()">Back</button>
      </div>

      <button id="writeBtn">Write a post</button>

      <div id="loginForm" class="hidden">
        <h3>Login</h3>
        <input type="text" id="username" placeholder="Username"><br>
        <input type="password" id="password" placeholder="Password"><br>
        <button id="loginBtn" onclick="login()">Login</button>
        <button onclick="closeLogin()">Cancel</button>
      </div>

      <div id="postForm" class="hidden">
        <h3>Write a Post</h3>
        <input type="text" id="postTitle" placeholder="Title"><br>
        <textarea id="postContent" placeholder="Content"></textarea><br>
        <input type="file" id="postImgFile" accept="image/*"><br>
        <select id="postCategory">
          <option>Seasonal Specials</option>
          <option>Drinks</option>
          <option>Bread</option>
          <option>Cookie</option>
          <option>Cake</option>
          <option>Chocolate</option>
          <option>Ice Cream</option>
          <option>Candy</option>
          <option>Jelly</option>
          <option>Others</option>
        </select><br>
        <button id="savePostBtn">Save</button>
        <button onclick="cancelPost()">Cancel</button>
      </div>
    </main>
  </div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBSoB4NomotkzPQgymHGqDhuy7POreIVzg",
    authDomain: "daye-sweets-blog.firebaseapp.com",
    projectId: "daye-sweets-blog",
    storageBucket: "daye-sweets-blog.appspot.com",
    messagingSenderId: "175818595197",
    appId: "1:175818595197:web:f2290dfcf5321bf1930a14"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  let loggedIn = false;
  let currentPostId = null;

  window.closeDetail = function() {
    document.getElementById("postDetail").style.display = "none";
  };
  window.closeLogin = function() {
    document.getElementById("loginForm").style.display = "none";
  };
  window.cancelPost = function() {
    document.getElementById("postForm").style.display = "none";
  };

  window.login = async function() {
    const u = document.getElementById("username").value;
    const p = document.getElementById("password").value;
    if (u === "day" && p === "1004") {
      loggedIn = true;
      alert("Login success!");
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("postForm").style.display = "block";
    } else {
      alert("Incorrect ID or password");
    }
  };

  window.savePost = async function() {
    const title = document.getElementById("postTitle").value;
    const content = document.getElementById("postContent").value;
    const category = document.getElementById("postCategory").value;
    const fileInput = document.getElementById("postImgFile");

    if (!title || !content || fileInput.files.length === 0) {
      alert("Title, Content, and Image required");
      return;
    }

    const file = fileInput.files[0];
    const storageRef = ref(storage, 'images/' + file.name);
    await uploadBytes(storageRef, file);
    const imgURL = await getDownloadURL(storageRef);

    await addDoc(collection(db, "posts"), {
      title,
      content,
      category,
      img: imgURL,
      author: "day",
      createdAt: Date.now()
    });

    document.getElementById("postForm").style.display = "none";
    loadPosts();
  };

  window.loadPosts = async function() {
    const postsContainer = document.getElementById("postsContainer");
    postsContainer.innerHTML = "";
    const querySnapshot = await getDocs(collection(db, "posts"));
    let postsArr = [];
    querySnapshot.forEach(docSnap => {
      postsArr.push({ ...docSnap.data(), id: docSnap.id });
    });
    postsArr.sort((a, b) => b.createdAt - a.createdAt);
    const recentPosts = postsArr.slice(0, 8);
    recentPosts.forEach((p) => {
      const div = document.createElement("div");
      div.className = "post";
      div.innerHTML = `<img src="${p.img}" alt=""><h3>${p.title}</h3>`;
      div.onclick = () => viewPost(p.id);
      postsContainer.appendChild(div);
    });
  };

  window.viewPost = async function(id) {
    currentPostId = id;
    const docRef = doc(db, "posts", id);
    const docSnap = await getDoc(docRef);
    if (!docSnap.exists()) return;
    const post = docSnap.data();

    document.getElementById("detailImg").src = post.img;
    document.getElementById("detailTitle").innerText = post.title;
    document.getElementById("detailContent").innerText = post.content;
    document.getElementById("postDetail").style.display = "flex";

    if (loggedIn) {
      document.querySelector(".edit-delete").classList.remove("hidden");
    } else {
      document.querySelector(".edit-delete").classList.add("hidden");
    }
  };

  document.getElementById("editBtn").onclick = async function() {
    const docRef = doc(db, "posts", currentPostId);
    const docSnap = await getDoc(docRef);
    if (!docSnap.exists()) return;
    const post = docSnap.data();

    document.getElementById("postTitle").value = post.title;
    document.getElementById("postContent").value = post.content;
    document.getElementById("postCategory").value = post.category;
    document.getElementById("postForm").style.display = "block";

    document.getElementById("savePostBtn").onclick = async function() {
      await updateDoc(docRef, {
        title: document.getElementById("postTitle").value,
        content: document.getElementById("postContent").value,
        category: document.getElementById("postCategory").value,
        updatedAt: Date.now()
      });
      document.getElementById("postForm").style.display = "none";
      loadPosts();
    };
  };

  document.getElementById("deleteBtn").onclick = async function() {
    const docRef = doc(db, "posts", currentPostId);
    await deleteDoc(docRef);
    document.getElementById("postDetail").style.display = "none";
    loadPosts();
  };

  document.getElementById("writeBtn").addEventListener("click", () => {
    document.getElementById("loginForm").style.display = "block";
    document.getElementById("loginForm").scrollIntoView({ behavior: "smooth" });
  });

  window.loadPosts();
</script>
</body>
</html>

